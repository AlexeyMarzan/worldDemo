<!DOCTYPE html><html>
<head>
    <meta charset="utf-8">
</head>
<body>
    <link rel="stylesheet" type="text/css" href="mystyles.css" media="screen" />
    <div id='js-rotation-example'></div>

    <script src='https://code.jquery.com/jquery-3.3.1.min.js'></script>
    <script src="http://d3js.org/d3.v5.min.js"></script>
    <script src="http://d3js.org/topojson.v0.min.js"></script>
    <script src="example.js"></script>

    <script>
        var orto = true;
        var width = $(window).width(),
            height = $(window).height();

        var sc = Math.min(width, height) * (orto ? 0.4:0.5);
        var lat = 0;
        var lo = -23.5;
        var projection = (orto ? d3.geoOrthographic() : d3.geoMercator())
            .scale(sc)
            .translate([width / 2, height / 2])
            .rotate([lat, lo])
            .clipAngle(90);

        var path = d3.geoPath(projection);

        var svg = d3.select("#js-rotation-example")
            .append("svg")
            .attr("width", width-20)
            .attr("height", height-20);

        if (orto)
            svg.append("circle").attr("cx", width / 2).attr("cy", height / 2).attr("r", sc + 1).style("fill", "#477cc7");


        svg.selectAll(".land")
            .data([topojson.object(worldtopo, worldtopo.objects.land)])
            .enter().append('path')
            .attr('class', 'land')
            .attr("d", path);

        d3.json('/grid').then(function(featureCollection) {
            grid = svg.selectAll('.geojson').data(featureCollection.features, function(d, i) {
                //console.log('Feature ', i, d);
            }).enter()
                .append('path')
                .attr("class",'geojson')
                .attr("d", function(d,i) {
                    //console.log("GRID:", i, ' -- ', d);
                    return path(d,i);
                });
        });


        setInterval(function () {
            lat = lat + 0.1;
            projection.rotate([lat, lo]);


            svg.selectAll(".land")
                .attr("d", path);

            svg.selectAll(".geojson")
                .attr("d", path);


        }, 100);

        setInterval(function () {
            d3.json('/map').then(function (data) {
                //console.log('MAP IN:', data);
                svg.selectAll('.geojson')
                    .style('fill', function (d, i) {
                        //console.log('MAP:', i, d);
                        var found = null;
                        data.forEach(function(entry) {
                            if (Math.abs(entry.longitude-d.properties.longitude)<4 && Math.abs(entry.latitude-d.properties.latitude)<4) // TODO Учесть gridSize
                                //console.log("MATCH: ", i,d,entry)
                                found = entry.foreground;
                        });
                        if (found != null) {
                            return found;
                        } else {
                            //console.log("MAP: ", i, d, data)
                            return 'none';
                        }
                    })
                    .attr("d", path);
            });
        }, 5000);


    </script>
</body></html>